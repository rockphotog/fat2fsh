name: Generate FSH from FAT API

on:
  workflow_dispatch:
    inputs:
      code_system_id:
        description: 'Code System ID to download and convert'
        required: true
        default: '1101'
        type: string
      include_inactive:
        description: 'Include inactive codes'
        required: false
        default: false
        type: boolean

jobs:
  generate-fsh:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Generate FSH files
      run: |
        if [ "${{ inputs.include_inactive }}" = "true" ]; then
          python3 fat2fsh.py -c "${{ inputs.code_system_id }}" --include-inactive -v
        else
          python3 fat2fsh.py -c "${{ inputs.code_system_id }}" -v
        fi
        
    - name: Display FSH output for easy copying
      run: |
        echo "üéØ Generated FSH for Code System: ${{ inputs.code_system_id }}"
        echo "==============================================================="
        echo ""
        
        # Find the specific FSH file
        fsh_file="fsh/no-kodeverk-${{ inputs.code_system_id }}.fsh"
        
        if [ -f "$fsh_file" ]; then
          echo "üìÑ Complete FSH Content (ready to copy):"
          echo "========================================="
          echo ""
          echo "```fsh"
          cat "$fsh_file"
          echo "```"
          echo ""
          echo "üìÅ File location: $fsh_file"
          echo "üìä File size: $(wc -l < "$fsh_file") lines"
        else
          echo "‚ùå FSH file not found: $fsh_file"
          echo "üìÅ Available files:"
          find . -name "*.fsh" -o -name "*.json" | sort
        fi
        
        echo ""
        echo "üìã Quick copy commands for local use:"
        echo "======================================"
        if [ "${{ inputs.include_inactive }}" = "true" ]; then
          echo "python3 fat2fsh.py -c ${{ inputs.code_system_id }} --include-inactive -v"
        else
          echo "python3 fat2fsh.py -c ${{ inputs.code_system_id }} -v"
        fi
        
    - name: Create artifact structure
      run: |
        mkdir -p artifacts/fat artifacts/fsh
        cp fat/*.json artifacts/fat/ 2>/dev/null || echo "No JSON files to copy"
        cp fsh/*.fsh artifacts/fsh/ 2>/dev/null || echo "No FSH files to copy"
        
    - name: Upload FSH artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fsh-files-${{ inputs.code_system_id }}
        path: artifacts/
        retention-days: 30
        
    - name: Summary
      run: |
        echo "## üéâ FSH Generation Complete for Code System ${{ inputs.code_system_id }}!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Code System ID:** \`${{ inputs.code_system_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Include Inactive:** \`${{ inputs.include_inactive }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if the specific files were generated
        fsh_file="fsh/no-kodeverk-${{ inputs.code_system_id }}.fsh"
        json_file="fat/${{ inputs.code_system_id }}.json"
        
        if [ -f "$fsh_file" ] && [ -f "$json_file" ]; then
          echo "### ‚úÖ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`no-kodeverk-${{ inputs.code_system_id }}.fsh\` | FHIR Shorthand file |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ inputs.code_system_id }}.json\` | Original FAT API data |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã FSH Content (Ready to Copy):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The complete FSH content is displayed in the workflow logs above and available in the artifact download." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå File Generation Issues:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Expected files not found. Check the workflow logs for errors." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì• Download Artifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact name:** \`fsh-files-${{ inputs.code_system_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Contains:** Both FSH and JSON files for code system ${{ inputs.code_system_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Retention:** 30 days" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîß Reproduce Locally" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.include_inactive }}" = "true" ]; then
          echo "python3 fat2fsh.py -c ${{ inputs.code_system_id }} --include-inactive -v" >> $GITHUB_STEP_SUMMARY
        else
          echo "python3 fat2fsh.py -c ${{ inputs.code_system_id }} -v" >> $GITHUB_STEP_SUMMARY
        fi
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY